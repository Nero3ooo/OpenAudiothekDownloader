<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='styles.css') }}">
      <link rel="icon" href="{{url_for('static', filename='icons/icon_144x144.png')}}" type="image/png">
  <link rel="icon" href="{{url_for('static', filename='icons/icon_192x192.png')}}" type="image/png">
  <link rel="icon" href="{{url_for('static', filename='icons/icon_512x512.png')}}" type="image/png">
  <link rel="apple-touch-icon" href="{{url_for('static', filename='icons/icon_144x144.png')}}" type="image/png">
  <link rel="apple-touch-icon" href="{{url_for('static', filename='icons/icon_192x192.png')}}" type="image/png">
  <link rel="apple-touch-icon" href="{{url_for('static', filename='icons/icon_512x512.png')}}" type="image/png">
  <link rel="manifest" href="/manifest.json">
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function() {
        navigator.serviceWorker.register("/sw.js").then(function(registration) {
          console.log('ServiceWorker registration successful with scope: ', registration.scope);
        }, function(err) {
          console.log('ServiceWorker registration failed: ', err);
        });
      });
    }
  </script>

  <title>Open Audiothek Downloader</title>
</head>
<body>

<div class="toggle-container">
  <div class="toggle" id="toggle"></div>
</div>

<div class="settings-icon-container">
  <div id="settings-icon" class="settings-icon">⚙</div>
</div>

<!-- Settings Modal -->
<div id="settings-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Cookie Settings</h2>
      <span class="close">&times;</span>
    </div>
    <div class="modal-body">
      <p class="cookie-info">To download age-restricted content, you need to provide cookies from your logged-in ARD session.</p>
      <div class="cookie-status">
        <span id="cookie-status">Checking cookies...</span>
      </div>
      <div class="cookie-help">
        <p><strong>How to get cookies from your browser:</strong></p>
        <ol>
          <li>Log in to <a href="https://www.ardmediathek.de" target="_blank">ardmediathek.de</a></li>
          <li>Open Developer Tools (F12)</li>
          <li>Go to "Application" or "Storage" tab</li>
          <li>Click on "Cookies" and select "ardmediathek.de"</li>
          <li>Copy all cookie values in format: <code>name=value; name2=value2</code></li>
        </ol>
      </div>
      <textarea id="cookie-input" placeholder="Paste cookies here (format: name=value; name2=value2)" rows="5"></textarea>
      <div class="cookie-buttons">
        <button type="button" id="save-cookies">Save Cookies</button>
        <button type="button" id="clear-cookies">Clear Cookies</button>
      </div>
      <p id="cookie-result"></p>
    </div>
  </div>
</div>

    <div class="container">
        <h1>OpenAudiothek Downloader</h1>
        <div class="form">
            <input type="text" id="url" placeholder="Shared Url"/>
            <button type="submit" id="download-show">Download Audio Show</button>
            <button type="submit" id="download-episode">Download Audio Episode</button>
            <button type="submit" id="download-movie">Download Video Movie</button>
            
            <div id="progress-area"></div>
            <p id="result"><br></p>
        </div>
    </div>
<script>
  const toggle = document.getElementById("toggle");
  // Check and apply the mode preference before the page loads
  const savedMode = localStorage.getItem('mode');
  if (savedMode === 'dark') {
    document.body.classList.add('dark-mode');
  } else {
    toggle.classList.add("checked");
  }

  // Toggle between dark and light modes and save preference
  function toggleMode() {
    const htmlElement = document.body;
    htmlElement.classList.toggle('dark-mode');
    toggle.classList.toggle("checked");
    const currentMode = htmlElement.classList.contains('dark-mode') ? 'dark' : 'light';
    localStorage.setItem('mode', currentMode);      
  }
  toggle.addEventListener("click", () => {toggleMode()});
</script>

<script>
  const resultBox = document.getElementById("result");
  const progressArea = document.getElementById("progress-area");

  function createProgressBar(taskId) {
    const wrapper = document.createElement("div");
    wrapper.id = `task-${taskId}`;
    wrapper.innerHTML = `
      <div class="progress-bar">
        <progress id="bar-${taskId}" value="0" max="100"></progress>
      </div>
      <div class="progress-message">
        <span id="msg-${taskId}">Starting...</span>
      </div>
    `;
    progressArea.appendChild(wrapper);
  }

  function pollProgress(taskId) {
    const bar = document.getElementById(`bar-${taskId}`);
    const msg = document.getElementById(`msg-${taskId}`);
    const interval = setInterval(() => {
      fetch(`/progress/${taskId}`)
        .then(res => res.json())
        .then(data => {
          msg.innerText =  parseFloat(data.progress).toFixed(1) + '%' || '';
          let raw = parseFloat(data.progress);
          bar.value = !isNaN(raw) ? raw : 0;
          if (data.status === 'finished') {
            afterProgress();
            clearInterval(interval);
          } else if (data.status === 'error') {
            msg.innerText = data.message;
            afterProgress();
            clearInterval(interval);
          }
        })
        .catch(() => {
          msg.innerText = "Error polling progress";
          afterProgress();
          clearInterval(interval);
        });
    }, 1000);
    function afterProgress() {
      // remove progress bar after 5 seconds
      setTimeout(() => {
        progressArea.removeChild(document.getElementById(`task-${taskId}`));
      }, 5000);
    }
    
  }

  // Function to handle the download button click
  const downloadShowBtn = document.getElementById("download-show");
  const downloadEpisodeBtn = document.getElementById("download-episode");
  const downloadMovieBtn = document.getElementById("download-movie");
  const urlInput = document.getElementById("url");

  const postUrl = async (path) => {
    let value = document.getElementById("url").value;
    let myBody = {"textfield": document.getElementById("url").value};

    // rest api call
    fetch('/'+path, {
      method: 'POST',
      body: JSON.stringify(myBody), // string or object
      headers: {
        'Content-Type': 'application/json'
      }
    }).then(res => res.json())
    .then(data => {
      if (data.task_id) {
        createProgressBar(data.task_id);
        pollProgress(data.task_id);
      }
      urlInput.value = "";
    })
    .catch(err => {
      resultBox.innerText = "Server error.";
    });
  }

  // add events for button and inputfield
  downloadShowBtn.addEventListener("click", () => {postUrl('download-show')});
  downloadEpisodeBtn.addEventListener("click", () => {postUrl('download-episode')});
  downloadMovieBtn.addEventListener("click", () => {postUrl('download-movie')});
  //urlInput.addEventListener("keydown",
  //function(event) {
  //  if (event.key === 'Enter') {
  //      postUrl();
  //  }
  //});

  // add sharehandler function
  const url = new URL(document.location);
  const sharedLink = url.searchParams.get("link");
  let description = url.searchParams.get("description");
  try {
    if(sharedLink !== null){
      new URL(sharedLink);
      document.getElementById("url").value = sharedLink;
    } else if(description !== null){
      const searchString = "https";
      const startIndex = description.indexOf(searchString);

      if (startIndex !== -1) {
        description = description.slice(startIndex);
        new URL(description);
        document.getElementById("url").value = description;
      } else {
        document.getElementById("result").innerText = "Shared Text does not contain https";
      }
    }
  } catch (_) {
    document.getElementById("result").innerText = "Invalid URL";
  }

  window.addEventListener('DOMContentLoaded', () => {
    // Fetch and show all active tasks
    fetch('/active-tasks')
      .then(res => res.json())
      .then(data => {
        (data.tasks || []).forEach(task => {
          createProgressBar(task.task_id);
          pollProgress(task.task_id);
        });
      });

    // Load cookie status
    updateCookieStatus();
  });

  // Modal functionality
  const modal = document.getElementById('settings-modal');
  const settingsIcon = document.getElementById('settings-icon');
  const closeBtn = document.querySelector('.close');

  settingsIcon.addEventListener('click', () => {
    modal.style.display = 'block';
    updateCookieStatus();
  });

  closeBtn.addEventListener('click', () => {
    modal.style.display = 'none';
  });

  window.addEventListener('click', (event) => {
    if (event.target === modal) {
      modal.style.display = 'none';
    }
  });

  // Cookie management functions
  function updateCookieStatus() {
    fetch('/cookies/info')
      .then(res => res.json())
      .then(data => {
        const statusEl = document.getElementById('cookie-status');
        if (data.has_cookies) {
          statusEl.innerText = `✓ ${data.count} cookies stored`;
          statusEl.style.color = 'green';
        } else {
          statusEl.innerText = '✗ No cookies stored';
          statusEl.style.color = 'orange';
        }
      })
      .catch(err => {
        document.getElementById('cookie-status').innerText = 'Error checking cookies';
      });
  }

  document.getElementById('save-cookies').addEventListener('click', () => {
    const cookieInput = document.getElementById('cookie-input');
    const cookieResult = document.getElementById('cookie-result');
    const cookies = cookieInput.value.trim();

    if (!cookies) {
      cookieResult.innerText = 'Please enter cookies';
      cookieResult.style.color = 'red';
      return;
    }

    fetch('/cookies/set', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ cookies: cookies })
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        cookieResult.innerText = data.message;
        cookieResult.style.color = 'green';
        cookieInput.value = '';
        updateCookieStatus();
      } else {
        cookieResult.innerText = data.message;
        cookieResult.style.color = 'red';
      }
    })
    .catch(err => {
      cookieResult.innerText = 'Error saving cookies';
      cookieResult.style.color = 'red';
    });
  });

  document.getElementById('clear-cookies').addEventListener('click', () => {
    if (!confirm('Are you sure you want to clear all stored cookies?')) {
      return;
    }

    fetch('/cookies/clear', {
      method: 'POST'
    })
    .then(res => res.json())
    .then(data => {
      const cookieResult = document.getElementById('cookie-result');
      cookieResult.innerText = data.message;
      cookieResult.style.color = 'green';
      updateCookieStatus();
    })
    .catch(err => {
      document.getElementById('cookie-result').innerText = 'Error clearing cookies';
      });
  });

</script>

</body>
</html>